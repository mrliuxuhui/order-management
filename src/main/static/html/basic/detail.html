<!DOCTYPE html>
<!--
This is a starter template page. Use this page to start your new project from
scratch. This page gets rid of all links and provides the needed markup only.
-->
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>餐饮管理系统</title>
    <!-- Tell the browser to be responsive to screen width -->
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <link rel="stylesheet" href="../../libs/bootstrap/css/bootstrap.min.css">
    <!-- bootstrap validator -->
    <link rel="stylesheet" href="../../libs/bootstrapvalidator/css/bootstrapValidator.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="../../libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="../../libs/hui/Hui-iconfont/1.0.8/iconfont.css">
    <!-- DataTables -->
    <link rel="stylesheet" href="../../libs/datatables.net-bs/css/dataTables.bootstrap.min.css">
    <!-- Select2 -->
    <link rel="stylesheet" href="../../libs/select2/css/select2.min.css">
    <!-- Ionicons -->
    <link rel="stylesheet" href="../../libs/Ionicons/css/ionicons.min.css">
    <!-- Theme style -->
    <link rel="stylesheet" href="../../libs/dist/css/AdminLTE.min.css">
    <!-- AdminLTE Skins. We have chosen the skin-blue for this starter
          page. However, you can choose any other skin. Make sure you
          apply the skin class to the body tag so the changes take effect. -->
    <link rel="stylesheet" href="../../libs/dist/css/skins/skin-blue.min.css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Google Font -->
    <link rel="stylesheet" href="../../libs/google-font/css.css">
    <link rel="stylesheet" href="../../libs/hui/admin/css/H-ui.admin.css">
    <style type="text/css">
        table.dataTable tbody tr.selected {
            background-color: #B0BED9;
        }
    </style>
</head>
<!--
BODY TAG OPTIONS:
=================
Apply one or more of the following classes to get the
desired effect
|---------------------------------------------------------|
| SKINS         | skin-blue                               |
|               | skin-black                              |
|               | skin-purple                             |
|               | skin-yellow                             |
|               | skin-red                                |
|               | skin-green                              |
|---------------------------------------------------------|
|LAYOUT OPTIONS | fixed                                   |
|               | layout-boxed                            |
|               | layout-top-nav                          |
|               | sidebar-collapse                        |
|               | sidebar-mini                            |
|---------------------------------------------------------|
-->
<body class="hold-transition">
<div class="wrapper">

    <!-- Content Header (Page header) -->
    <section class="content-header">
        <h1>
            详单管理
            <small>查询详单、更新点餐量、添加菜品</small>
        </h1>
        <ol class="breadcrumb">
            <li><a href="#"><i class="fa fa-dashboard"></i> 首页</a></li>
            <li><a href="#">结算</a></li>
            <li class="active">详单管理</li>
        </ol>
    </section>

    <!-- Main content -->
    <section class="content">
        <div class="row">
            <div class="col-md-4 col-md-offset-1">
                <div class="form-group">
                    <label>快速查单</label>
                    <select class="form-control select2">
                        <option selected="selected">Alabama</option>
                        <option>Alaska</option>
                        <option>California</option>
                        <option>Delaware</option>
                        <option>Tennessee</option>
                        <option>Texas</option>
                        <option>Washington</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="box box-primary">
            <div class="box-header">
                <div class="row">
                    <div class="col-md-3">
                        <div class="col-sm-4 text-right"><h5>订单编号</h5></div>
                        <div class="col-sm-8" id="order-number"><h5>201709210024</h5></div>
                    </div>
                    <div class="col-md-3">
                        <div class="col-sm-4 text-right"><h5>桌号</h5></div>
                        <div class="col-sm-8" id="table-number"><h5>5</h5></div>
                    </div>
                </div>
                <br/>
                <div class="row pull-left col-lg-offset-0 col-lg-6 col-md-6 col-md-offset-0">
                    <div class="col-lg-6 col-md-6"><button type="button" class="btn btn-block btn-success" data-toggle="modal" data-target="#modal-add" ><i class="fa fa-plus-circle"></i> 新增</button></div>
                    <div class="col-lg-6 col-md-6"><button type="button" class="btn btn-block btn-danger" data-toggle="modal" data-target="#modal-del"><i class="fa fa-minus-circle"></i> 批量删除</button></div>
                </div>
            </div>
            <!-- /.box-header -->
            <div class="box-body">
                <table id="example1" class="table table-bordered table-striped">
                    <thead>
                    <tr>
                        <th>序号</th>
                        <th>菜名</th>
                        <th>点餐量</th>
                        <th>上餐量</th>
                        <th>单位</th>
                        <th>单价</th>
                        <th>总价</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td></td>
                        <td>2</td>
                        <td>3</td>
                        <td>4</td>
                        <td>5</td>
                        <td>5</td>
                        <td>6</td>
                        <td></td>
                    </tr>
                    </tbody>
                    <tfoot>
                    <tr>
                        <th>序号</th>
                        <th>菜名</th>
                        <th>点餐量</th>
                        <th>上餐量</th>
                        <th>单位</th>
                        <th>单价</th>
                        <th>总价</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                    </tfoot>
                </table>
            </div>
            <!-- /.box-body -->
        </div>

    </section>
    <!-- /.content-wrapper -->

    <div class="modal fade" id="modal-add" tabindex="-1" role="dialog">
        <div class="modal-dialog">

            <form id="data-form" class="form-horizontal" action="/admin/api/order/{orderId}/detail" method="post" onsubmit="javascript:return false">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">添加菜品</h4>
                </div>
                <div class="modal-body">
                    <div class="box-body">
                        <input type="hidden" id="orderId" value="">
                        <div class="form-group">
                            <label for="menuId" class="col-sm-2 control-label">菜名</label>
                            <div class="col-sm-10 ">
                                <select class="form-control select2" id="menuId" name="menuId" placeholder="请选择菜品">
                                    <option selected="selected">Alabama</option>
                                    <option>Alaska</option>
                                    <option>California</option>
                                    <option>Delaware</option>
                                    <option>Tennessee</option>
                                    <option>Texas</option>
                                    <option>Washington</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="mount" class="col-sm-2 control-label">点餐量</label>
                            <div class="col-sm-10 ">
                            <input type="text" class="form-control" name="mount" id="mount" placeholder="点餐量" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="unit" class="col-sm-2 control-label">单位</label>
                            <div class="col-sm-10 ">
                            <select class="form-control" id="unit" name="unit" required>
                                <option value="1">份</option>
                            </select>
                            </div>
                            <!--<p class="help-block">Example block-level help text here.</p>-->
                        </div>
                        <div class="form-group">
                            <label for="price" class="col-sm-2 control-label">单价</label>
                            <div class="col-sm-10 ">
                                <input type="text" class="form-control" id="price" disabled>
                            </div>
                            <!--<p class="help-block">Example block-level help text here.</p>-->
                        </div>
                        <div class="form-group">
                            <label for="total" class="col-sm-2 control-label">总价</label>
                            <div class="col-sm-10 ">
                                <input type="text" class="form-control" id="total" disabled>
                            </div>
                        </div>

                    </div>
                    <!-- /.box-body -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default pull-left" data-dismiss="modal">关闭</button>
                    <button type="button" id="submitBtn" class="btn btn-primary">保存</button>
                </div>
            </div>
            </form>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
    <!-- /.modal -->

    <div class="modal fade" id="modal-update" tabindex="-1" role="dialog">
        <div class="modal-dialog">

            <form id="data-form-update" class="form-horizontal" method="post">
                <input type="hidden" id="detailId" value="">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title">修改点餐量</h4>
                    </div>
                    <div class="modal-body">
                        <div class="box-body">
                            <div class="form-group">
                                <label for="dish" class="col-sm-2 control-label">菜名</label>
                                <div class="col-sm-10 ">
                                    <input type="text" class="form-control" id="dish" disabled>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="mount" class="col-sm-2 control-label">点餐量</label>
                                <div class="col-sm-10 ">
                                    <input type="text" class="form-control" name="mount" id="mount" placeholder="点餐量" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="unit" class="col-sm-2 control-label">单位</label>
                                <div class="col-sm-10 ">
                                    <input type="text" class="form-control" id="unit" disabled>
                                </div>
                                <!--<p class="help-block">Example block-level help text here.</p>-->
                            </div>
                            <div class="form-group">
                                <label for="price" class="col-sm-2 control-label">单价</label>
                                <div class="col-sm-10 ">
                                    <input type="text" class="form-control" id="price" disabled>
                                </div>
                                <!--<p class="help-block">Example block-level help text here.</p>-->
                            </div>
                            <div class="form-group">
                                <label for="total" class="col-sm-2 control-label">总价</label>
                                <div class="col-sm-10 ">
                                    <input type="text" class="form-control" id="total" disabled>
                                </div>
                            </div>

                        </div>
                        <!-- /.box-body -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default pull-left" data-dismiss="modal">关闭</button>
                        <button type="button" id="updateMountBtn" class="btn btn-primary">保存</button>
                    </div>
                </div>
            </form>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
    <!-- /.modal -->

    <div class="modal fade" tabindex="-1" role="dialog" id="modal-del">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">批量删除</h4>
                </div>
                <div class="modal-body">
                    <p>是否确认全部删除？</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default pull-left" data-dismiss="modal">取消</button>
                    <button type="button" id="delBtn" class="btn btn-primary">删除</button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
    <!-- /.modal -->

</div>
<!-- ./wrapper -->

<!-- REQUIRED JS SCRIPTS -->

<!-- jQuery 3 -->
<script src="../../libs/jquery/jquery.min.js"></script>
<!-- Bootstrap 3.3.7 -->
<script src="../../libs/bootstrap/js/bootstrap.min.js"></script>
<!-- DataTables -->
<script src="../../libs/datatables.net/js/jquery.dataTables.min.js"></script>
<script src="../../libs/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
<script src="../../libs/bootstrapvalidator/js/bootstrapValidator.min.js"></script>
<!-- Select2 -->
<script src="../../libs/select2/js/select2.full.min.js"></script>
<!-- AdminLTE App -->
<script src="../../libs/dist/js/adminlte.min.js"></script>
<!-- art Template -->
<script src="../../libs/arttemplate/template-web.js"></script>

<script src="../../libs/hui/admin/H-ui.admin.js"></script>
<script src="../../libs/jquery-serializejson/jquery.serializejson.min.js"></script>
<!-- Optionally, you can add Slimscroll and FastClick plugins.
     Both of these plugins are recommended to enhance the
     user experience. -->
<script src="../../js/order/detail.js"></script>
<script id="opTemplate" type="text/html">
    {{each func as button}}
    <button type="button" class="btn btn-{{button.type}} btn-sm" id="{{button.id}}">{{button.name}}</button>
    {{/each}}
</script>
<script type="text/javascript">

    function add0(m){return m<10?'0'+m:m }
    function format(timestamp)
    {
        //timestamp是整数，否则要parseInt转换,不会出现少个0的情况

        var time = new Date(timestamp);
        var year = time.getFullYear();
        var month = time.getMonth()+1;
        var date = time.getDate();
        var hours = time.getHours();
        var minutes = time.getMinutes();
        var seconds = time.getSeconds();
        return year+'-'+add0(month)+'-'+add0(date)+' '+add0(hours)+':'+add0(minutes)+':'+add0(seconds);
    }

    //修改
    function edit(id){

    }

    //删除
    function del(id){

    }

    $(function () {

        $('.select2').select2();
        //modal
        $("#modal-add").on("hidden.bs.modal", function() {
            $(this).removeData("hidden.bs.modal");
            $("#menuId").val("");
        });

        $("#modal-add").on("show.bs.modal", function() {
            var menuId = $(this).find("#menuId").val();
            var numReg = new RegExp("^\\d+$");
            if(null!=menuId&&numReg.test(menuId)){
                $(this).find(".modal-title").text("更新菜品");
                $("#data-form").attr("action","/admin/api/menu/"+menuId);
                $("#data-form").attr("method","put");

            }else{
                $(this).find(".modal-title").text("新建菜品");
                $("#data-form").attr("action","/admin/api/menu");
                $("#data-form").attr("method","post");
            }
        });

        //validator
        $("#data-form").bootstrapValidator({
            message: '输入不合法',
            submitHandler: function (valiadtor, loginForm, submitButton) {

            },
            fields:{
                name:{
                    validators:{
                        notEmpty:{
                            message:"不可为空"
                        },
                        stringLength:{
                            max:30,
                            message:"最大长度不可超过30"
                        }
                    }
                },
                price:{
                    validators:{
                        notEmpty:{
                            message:"不可为空"
                        },
                        numeric:{
                            message:"只能输入数字",
                            callback:function(value,validator){
                                if(value<=0||value>1000){
                                    return false;
                                }
                            }
                        }
                    }
                }
            }
        });

        $("#submitBtn").on("click",function(){
            var loginForm = $("#data-form");
            var validator = $("#data-form").data("bootstrapValidator");
            validator.validate();
            if(validator.isValid()){
                var action = loginForm.attr("action");
                //var createRex = new RegExp("menu$");
                var updateRex = new RegExp("menu/\d+$");
                var method = "post";
                if(updateRex.test(action)){
                    method = "put";
                }
                $.ajax({
                    url:action,
                    type:method,
                    data:loginForm.serialize(),
                    success:function(result){
                        console.log(result);
                        $("#modal-add").modal("hide");
                        table.draw();
                    },
                    error:function(req,error){
                        console.log(error);
                    }
                });
            }
        });

        //批量删除
        $("#modal-del").on("show.bs.modal", function() {
            var selected = table.rows('.selected').data().length;
            if(null!=selected&&selected>0){
                $(this).find("div.modal-body > p").text("是否确认全部删除？");
            }else{
                $(this).find("div.modal-body > p").text("没有选择要删除的记录！");
            }
        });

        $("#delBtn").on("click",function(){
            var data = table.rows('.selected').data();
            var menuIds = new Array();
            $.each(data, function (index, value) {
                menuIds.push(data.id);
            });

            $.ajax({
                url:"/admin/api/menu",
                type:"delete",
                dataType:"json",
                data:menuIds,
                success:function(result){
                    table.draw();
                }
            });
        });

        //单行
        $("#editRowBtn").on("click",function(){
            var data = table.rows($(this).parent("tr")).data();
            if(null==data||null==data.id){
                return;
            }
            var id = data.id;
            $.ajax({
                url:"/admin/api/menu/"+id,
                success:function(result){
                    if(null==result){
                        return;
                    }
                    $('#data-form input[name="name"]').val(result.name);
                    $('#data-form input[name="price"]').val(result.price);
                    $('#data-form select[name="unit"] > option[value="'+result.unit+'"]').attr("selected",true);
                    $('#data-form select[name="categoryId"] > option[value="'+result.categoryId+'"]').attr("selected",true);
                    $('#data-form text[name="profile"]').text(result.profile);

                    $("#menuId").val(id);

                    $("#modal-add").modal("show");
                }

            });
        });

        //del
        $("#delRowBtn").on("click",function(){
            var data = table.rows($(this).parent("tr")).data();
            if(null==data||null==data.id){
                return;
            }
            var id = data.id;
            $.ajax({
                type:"delete",
                url:"/admin/api/menu/"+id,
                success:function(result){
                    table.draw();
                }

            });
        });

        //table
        var tpl = $("#opTemplate").html();
        //预编译模板
        var render = template.compile(tpl);

        var table = $('#example1').DataTable({
            ajax: {
                url: "/admin/api/menu"
            },
            "order": [[1, 'asc']],// dt默认是第一列升序排列 这里第一列为序号列，所以设置为不排序，并把默认的排序列设置到后面
            "serverSide": true,
            "searching":false,
            "fnServerData": function(sUrl, aoData, fnCallback){
                $.ajax({
                    url:"/admin/api/menu",
                    dataType:"json",
                    data:{"dataTableParam":JSON.stringify(aoData)},
                    success:function(result){
                        fnCallback(result);
                    }
                });
            },
            //"sPaginationType": "full_numbers",
            "bPaginate": false,  //是否显示分页
            "columns": [
                {"data": null}, //因为要加行号，所以要多一列，不然会把第一列覆盖
                {"data": "name"},
                {"data": "img"},
                {"data": "price"},
                {"data": "categoryId"},
                {"data": "profile"},
                {"data": "createTime"},
                {"data": "updateTime"},
                {"data": null}
            ],
            "columnDefs": [
                {
                    "searchable": false,
                    "orderable": false,
                    "targets": [0.-1]
                },
                {
                    "targets": 8,
                    "render": function (data, type, row, meta) {
                        var context =
                        {
                            func: [
                                {"name": "修改", "fn": "edit(" + row.id + ")", "type": "primary", "id":"editRowBtn"},
                                {"name": "删除", "fn": "del(\'" + row.id + "\')", "type": "danger", "id":"delRowBtn"}
                            ]
                        };
                        var html = render(context);
                        return html;
                    }
                },{
                    "targets":[6,7],
                    "render": function ( data, type, row, meta ) {
                        return format(data);
                    }
                },{
                    "targets":4,
                    "render":function ( data, type, row, meta ) {
                        return row.foodCategory?row.foodCategory.name:"";
                    }
                }

            ]

        });

        //多选
        $('#example1 tbody').on('click', 'tr', function () {
            $(this).toggleClass('selected');
        });

        //添加序号
        //不管是排序，还是分页，还是搜索最后都会重画，这里监听draw事件即可
        table.on('draw.dt',function() {
            table.column(0, {
                search: 'applied',
                order: 'applied'
            }).nodes().each(function(cell, i) {
                //i 从0开始，所以这里先加1
                i = i+1;
                //服务器模式下获取分页信息
                var page = table.page.info();
                //当前第几页，从0开始
                var pageno = page.page;
                //每页数据
                var length = page.length;
                //行号等于 页数*每页数据长度+行号
                var columnIndex = (i+pageno*length);
                cell.innerHTML = columnIndex;
            });
        }).draw();

    });


</script>
</body>
</html>